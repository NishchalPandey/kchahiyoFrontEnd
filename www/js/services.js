angular.module("starter.services",[]).value("serverAddress","http://www.cinemagharhd.com/k-chahiyo/php").service("kchahiyoServices",["$http","$q","serverAddress",function(e,t,n){var r=[],o=function(t,o,a,i,s){return e.get(n+"/getPosts.php",{params:{catagory:t,locationInfo:o,pageNum:a,searchText:i,selectedOption:s}}).then(function(e){return r.concat(e.data),e})};this.postEdited=!1,this.getPostsByCatagory=o,this.getPostsBySearchtext=o,this.insertPost=function(t){var r=$.param({email:t.email,unique_id:t.uniqueId,title:t.title,content:t.content,catagory:t.catagory,sub_catagory:t.sub_catagory.trim(),post_near_city:t.city,post_location:t.location,hide_user_details:t.hideUserDetails});return e({url:n+"/insertPost.php",method:"POST",data:r,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})},this.getCitiesByState=function(t){return e.get(n+"/getCitiesByState.php",{params:{stateName:t}}).then(function r(r){return r},function o(o){return o})},this.getStatesByCountry=function(t){return e.get(n+"/getCitiesByState.php",{params:{countryName:t}})},this.getCityByZip=function(t){return e.get(n+"/getCityByZip.php",{params:{zip:t}})};var a={};this.getPostCatagories=function(){return e.get(n+"/getCatagoriesAndSubCatagories.php").then(function(e){var t=[];return e.data.content.forEach(function(e){-1==t.indexOf(e.catagory)&&t.push(e.catagory)}),a={catagories:t,catAndSubCat:e.data.content}},function(e){return null})},this.getPostById=function(o){if(0===r.length)return e.get(n+"/getPostById.php",{params:{id:o}});for(var a=t.defer(),i=0;i<r.length;i++)if(r[i].id==parseInt(o)){var s={};s.data=r[i],a.resolve(s)}return a.promise},this.getPostsByUserId=function(t){return e.get(n+"/getPostsByUserId.php",{params:{userId:t}}).then(function(e){return myPosts=e.data,e},function(e){})},this.getUserPostById=function(r){if(0===s.length)return e.get(n+"/getPostById.php",{params:{id:r}});for(var o=t.defer(),a=0;a<s.length;a++)if(s[a].id==parseInt(r)){var i={};i.data=s[a],o.resolve(i)}return o.promise;var s},this.savePost=function(t){var r=$.param({operationType:"save",title:t.title,content:t.content,userId:t.userId,postId:t.id});return e({url:n+"/postOperations.php",method:"POST",data:r,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})}}]).service("userAuthServices",["$http","$q","facebookServices","$window","$ionicModal","$ionicPopup","$ionicHistory","serverAddress",function(e,t,n,r,o,a,i,s){function u(n){var r=t.defer();return e({url:s+"/registerUser.php",method:"POST",data:n,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){return"success"==e.data.status?(d(e),void r.resolve("user details and post loaded")):void r.reject(e.data.content)},function(e){r.reject(e)}),r.promise}var c={facebookLogin:!1,loggedIn:!1,userPostsChanged:!1};this.updatePostImages=function(e,t){function n(e,t){for(var n=c.data.posts,r=0;r<n.length;r++)n[r].id==e&&(n[r].attached_images=t)}var r="";t.forEach(function(e){r=r+","+e}),r=r.substr(1,r.length-1),n(e,r)},this.updateUserProfilePage=function(e){c.data.userDetails.profilePic=e},this.setUserPostsChanged=function(e){c.userPostsChanged=e},this.isUserPostsChanged=function(){return c.userPostsChanged};var l=function(e){a.alert({title:e})};this.setStateAndCity=function(e,t){r.localStorage.setItem("stateName",e),r.localStorage.setItem("cityName",t)},this.getStateAndCity=function(){return{state:r.localStorage.getItem("stateName"),city:r.localStorage.getItem("cityName")}},this.isSetStateAndCity=function(){return""!=r.localStorage.getItem("stateName")&&""!=r.localStorage.getItem("cityName")},this.isFacebookLogin=function(){return c.facebookLogin},this.userLoggedIn=function(){c.loggedIn=!0},this.isUserLoggedIn=function(){return c.loggedIn},this.watchThisPost=function(t){var n=r.localStorage.getItem("userId");"undefined"==typeof c.watchedPosts&&(c.watchedPosts=Array()),c.watchedPosts.push(t),e.get(s+"/postOperations.php",{params:{operationType:"watch",userId:n,postId:t.id}}).then(function(e){l("Posting has been watched")},function(e){l(e)})},this.getWatchedPosts=function(){var t=r.localStorage.getItem("userId");return e.get(s+"/postOperations.php",{params:{operationType:"getWatchedPosts",userId:t}}).then(function(e){return c.watchedPosts=e.data,e})},this.getWatchedPostDetailsById=function(e){for(var t=c.watchedPosts.length,n=0;t>n;n++)if(c.watchedPosts[n].id==e)return c.watchedPosts[n];return null},this.removeWatchedPost=function(t,n){var o=r.localStorage.getItem("userId"),a=t.id;return e.get(s+"/postOperations.php",{params:{operationType:"removeWatchedPost",postId:a,userId:o}})},this.getUserDetails=function(){return c.data.userDetails},this.getUserPosts=function(){return c.data.posts},this.getPostById=function(e){for(var t=c.data.posts,n=0;n<t.length;n++)if(t[n].id==e)return t[n]},this.deletePost=function(t){var n=c.data.posts,r=$.param({operationType:"delete",userId:t.userId,postId:t.id});return n.splice(n.indexOf(t),1),e({url:s+"/postOperations.php",method:"POST",data:r,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})},this.logUserOut=function(){return r.localStorage.setItem("userId",""),r.localStorage.setItem("unique_id",""),n.logout().then(function(){c.loggedIn=!1,l("You have been logged out!")})},this.authenticateThisUser=function(a){var u=(t.defer(),function(e){var r=t.defer();return e.user={},e.loginModalButtons={},o.fromTemplateUrl("templates/tab-login.html",{scope:e}).then(function(t){e.loginModal=t,e.loginModal.show(),e.$on("loginComplete",function(t,n){e.loginModal.hide(),e.spinnerModal.remove()})}),e.loginModalButtons={closeButton:function(){e.$emit("loginComplete","complete"),r.reject("modal closed")},loginButton:function(){function t(t){e.$emit("loginComplete","complete"),l("You have successfully logged in!"),r.resolve("success, user data loaded")}function n(e){l("User credentials do not match!")}f(e.user).then(t,n)},fbLogin:function(){o.fromTemplateUrl("templates/spinner-modal.html",{scope:e}).then(function(t){e.spinnerModal=t,e.spinnerModal.show(),e.$on("loginComplete",function(t,n){e.spinnerModal.hide(),e.spinnerModal.remove()}),e.$on("loginError",function(t,n){e.spinnerModal.hide()})}),n.init().then(function(t){t.getLoginStatus().then(function(n){var o=n.authResponse.userID,a=n.authResponse.accessToken;p(o,a).then(function(t){return e.$emit("loginComplete","complete"),d(t),l("You have successfully logged in!"),r.resolve("user successfully logged in")},function(n){return c(t).then(function(t){return g(t,"fbUserRegister").then(function(t){e.$emit("loginComplete","complete"),d(t),r.resolve("user logged in and posts downloaded")},function(t){return e.$emit("loginError","error"),l("Registration server didn't respond, try again later! "),t})},function(t){l("error acquiring fb data, try again! "+t),e.$emit("loginError","error")})})},function(){c(t).then(function(t){return g(t,"fbUserRegister").then(function(t){e.$emit("loginComplete","complete"),d(t),r.resolve("user logged in and posts downloaded")})},function(t){l("error acquiring fb data, try again! "+t),e.$emit("loginError","error")})})},function(t){e.$emit("loginError","error")})},signUp:function(){h(e)}},r.promise}),c=function(e){return e.login().then(function(t){var n={accessToken:t.authResponse.accessToken};return e.getPublicProfile().then(function(t){return n.publicProfile=t,e.getProfilePicBig().then(function(e){return n.profilePicBig=e,n})},function(e){})},function(e){return e})},g=function(n,r){var o=t.defer(),a=$.param({operation:r,user:n});return e({url:s+"/registerUser.php",method:"POST",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){var t=e.data.content;"success"==e.data.status?o.resolve(e):o.reject(t)},function(e){o.reject(e)}),o.promise},h=function(e){e.loginModal.hide(),o.fromTemplateUrl("templates/tab-register.html",{scope:e}).then(function(t){e.registerModal=t,e.registerModal.show(),e.user={},e.notFilled=!0,e.user.firstName={text:"firstName",word:/^\s*\w*\s*$/}}),e.registerModalButtons={closeButton:function(){e.registerModal.hide(),i.goBack()},register:function(){e.notFilled=!1,g(e.user,"createUser").then(function(t){var n=t.data;"success"==n.status?(e.registerModal.hide(),l(n.content),i.goBack()):"error"==n.status&&l(n.content)},function(e){l("Error please try again!")})}}},m=function(){var e={userId:r.localStorage.getItem("userId")||"",unique_id:r.localStorage.getItem("unique_id")||""};if(""===e.userId||""===e.unique_id)return u(a);var t=e.userId,n=r.localStorage.getItem("unique_id");return p(t,n).then(function(e){return"success"},function(e){return u(a)})};return m()};var d=function(e){r.localStorage.setItem("userId",e.data.content.userDetails.uid),r.localStorage.setItem("unique_id",e.data.content.userDetails.unique_id),c.data=e.data.content},p=function(e,t){var n=$.param({operation:"loginStatus",userId:e,unique_id:t});return u(n)},f=function(e){var t=$.param({operation:"loginUser",username:e.username,password:e.password});return u(t)}}]).factory("googleMapFactory",["$q","$window",function(e,t){var n=!1,r=e.defer(),o=document.createElement("script");o.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZv-6hTAT3JfRWLaWiGvadnYvpsjR3DeU&callback=initMap&libraries=places",o.async=!0;var a=document.getElementsByTagName("script")[0];return a.parentNode.appendChild(o),t.initMap=function(){n||(n=!0,r.resolve(document.getElementsByClassName("pac-container")))},{load:r.promise}}]).factory("imageUploader",["$cordovaFileTransfer","userAuthServices","$ionicActionSheet","$ionicPopup","$cordovaFile","$cordovaCamera","$cordovaImagePicker","$q","$http","serverAddress",function(e,t,n,r,o,a,i,s,u,c){var l={numImageUploadable:0,maxImagesAllowed:0,setMaxImagesAllowed:function(e){this.maxImagesAllowed=e,this.numImageUploadable=e},maxImagesAllowedExceeded:function(){alert("Maximum "+this.maxImagesAllowed+" images can be attached!")},isMaxNoImagesExceeded:function(){return this.numImageUploadable<=0?(this.maxImagesAllowedExceeded(),!0):!1}},d=function(e){return o.createDir(cordova.file.dataDirectory,e.name,!0)},p=function(e,t){function n(e){var n=e.fullPath.substr(e.fullPath.lastIndexOf("/")+1),i=o(5)+n;window.resolveLocalFileSystemURL(cordova.file.dataDirectory+t.name,function(t){e.copyTo(t,i,r,a)},a)}function r(t){u.push(t.nativeURL),u.length===e.length&&i.resolve(u)}function o(e){for(var t="",n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",r=0;e>r;r++)t+=n.charAt(Math.floor(Math.random()*n.length));return t}function a(e){i.reject("copying failed")}var i=s.defer(),u=Array();"string"==typeof e&&(e=Array(e));for(var c=0;c<e.length;c++)window.resolveLocalFileSystemURL(e[c],n,a);return i.promise},f=function(){var e={destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.CAMERA,correctOrientation:!0,encodingType:Camera.EncodingType.JPEG,targetHeight:800,targetWidth:800};return a.getPicture(e)},g=function(e){var t={maximumImagesCount:e,width:800,height:800,quality:80};return i.getPictures(t)},h=function(e){var t=s.defer(),n=[];return f().then(function(r){d(e).then(function(o){p(r,e).then(function(e){for(;e.length>0;)n.push(e.pop());a.cleanup(),t.resolve(n)})})},function(e){t.reject("capturing pics aborted")}),t.promise},m=function(e,t){var n=s.defer(),r=[];return g(t).then(function(t){d(e).then(function(o){p(t,e).then(function(e){for(;e.length>0;)r.push(e.pop());n.resolve(r)})})},function(e){n.reject("error getting pics")}),n.promise},v=function(t,n,r,o){function a(e){l.reject("error uploading file :"+e)}function i(e){n.splice(n.indexOf(e.filePath),1),r.push(e.newFileName),0===n.length&&l.resolve("upload completed")}function u(t,n,r){var o={filePath:n,newFileName:""},a=s.defer(),i="insert",u=c+"/imageUploader.php",l={params:{directory:r,postId:t,operation:i}};return e.upload(u,n,l).then(function(e){var t=JSON.parse(e.response);return"success"==t.status?(o.newFileName=t.fileName,void a.resolve(o)):void a.reject(e.data)},function(e){a.reject(n)}),a.promise}var l=s.defer();if(0===n.length)return l.resolve("no image to upload"),l.promise;for(var d=n.length,p=0;d>p;p++)u(t,n[p],o).then(i,a);return l.promise},y=function(e,t){var n="delete",r=$.param({directory:"uploads",fileName:t,postId:e,operation:n});return u({url:c+"/imageUploader.php",method:"POST",data:r,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){return l.numImageUploadable++,e})},I=function(e,t){var r=(Array(),s.defer()),o={};if("post"==e?o.name="uploads":"profilePic"!=e&&"coverPic"!=e||(o.name="userProfilePics"),!l.isMaxNoImagesExceeded()||t){n.show({buttons:[{text:"Use Camera"},{text:"Select Images From Gallery"}],titleText:"Attach Images",cancelText:"Cancel",cancel:function(){r.reject("operation cancelled")},buttonClicked:function(e){return 0===e?h(o).then(function(e){r.resolve(e)}):1===e&&m(o).then(function(e){r.resolve(e)}),!0}});return r.promise}},P=function(e,t){t.splice(e,1),l.numImageUploadable++},w=function(n,r){function a(e,t){var n=e.substr(e.lastIndexOf("/")+1);return o.removeFile(cordova.file.dataDirectory+t,n).then(function(e){return e},function(e){return e})}var i=s.defer();l.numImageUploadable=1,l.setMaxImagesAllowed=1;var u=n.pop(),d="userProfilePics",p={filePath:u,newFileName:""},f="profilePic",g=c+"/imageUploader.php",h={params:{directory:d,userId:r,operation:f}};return e.upload(g,u,h).then(function(e){var n=JSON.parse(e.response);return"success"==n.status?(p.newFileName=n.fileName,a(p.filePath,d),t.updateUserProfilePage(p.newFileName),void i.resolve(p)):void i.reject(e.data)},function(e){}),i.promise},S=function(){var e,t,o,a,i,l=function(){return e},d=function(){r.alert({title:"Error",template:"No more images can be uploaded. Max. "+t+" images allowed!",buttons:[{text:"ok"}]})},p=function(n,r,s,u){e=n,o=r,a=void 0==s?[]:s,i=u,t=n,void 0!=o&&(e-=o.length)},f=function(){var t={name:i};return m(t,e).then(function(t){for(e-=t.length;t.length>0;)a.push(t.pop())})},g=function(){var t={name:i};return h(t).then(function(t){a.push(t.pop()),e-=1})},v=function(){if(0>=e)return d(),!1;var r=s.defer();return n.show({buttons:[{text:"Use Camera"},{text:"Select Images From Gallery"}],titleText:"Attach Images (Max. "+t+" images allowed)",cancelText:"Cancel",cancel:function(){r.reject(null)},buttonClicked:function(e){return 0===e?g().then(function(){r.resolve(a)}):1===e&&f().then(function(){r.resolve(a)}),!0}}),r.promise},y=function(t){a.splice(a.indexOf(t),1),e++},I=function(t,n){var r="delete",a=$.param({directory:"uploads",fileName:n,postId:t,operation:r});return u({url:c+"/imageUploader.php",method:"POST",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(t){return o.splice(o.indexOf(n),1),e++,t})};return{init:p,showActionSheet:v,getMaxNumImage:l,removeImageFromView:y,removeFileFromServer:I}};return{init:l,imageUpldr:S,removeImageFromDevice:P,copyFilesToLocalDirectory:p,uploadImages:v,uploadProfilePic:w,showActionSheet:I,removeFileFromServer:y}}]).service("viewFullScreenModal",["$ionicModal","$ionicScrollDelegate",function(e,t){this.init=function(n,r){return n.slideHasChanged=function(e){t.$getByHandle("scrollHandle"+e).zoomTo(1),n.active=e},n.closeModal=function(){n.viewFullScreenModal.hide()},n.$on("$destory",function(){n.viewFullScreenModal.remove()}),e.fromTemplateUrl("templates/modal-image.html",{scope:n})}}]);