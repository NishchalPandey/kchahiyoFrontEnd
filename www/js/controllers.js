angular.module("starter.controllers",["filterModule"]).controller("chooseStateCtrl",["$scope","$state","kchahiyoServices","userAuthServices","$stateParams",function(e,t,o,s,a){if(s.isSetStateAndCity()&&"false"==a.resetLocation){var n=s.getStateAndCity();return void t.go("tab.dash",{state:n.state,stateShort:n.state_abbr,city:n.city})}e.country="USA",e.stateChanged=function(e){t.go("chooseCity",{stateName:e})},o.getStatesByCountry(e.country).then(function(t){e.states=t.data,e.dataLoaded=!0})}]).controller("chooseCityCtrl",["$scope","$state","$stateParams","kchahiyoServices",function(e,t,o,s){e.cityChanged=function(e,o){t.go("tab.dash",{state:e,city:o})},e.stateName=o.stateName,e.city={},s.getCitiesByState(e.stateName).then(function(t){e.counties=t.data},function(){})}]).controller("DashCtrl",["$scope","facebookServices","$state","$sce","$ionicModal","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,s,a,n,i,r){return e.state=i.state,e.city=i.city,""===e.state||""===e.city?void o.go("chooseState"):(n.setStateAndCity(e.state,e.city),void r.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){}))}]).controller("CatPostCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,s,a){function n(e){if(0==e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}var i=a.getStateAndCity(),r=o.catagory;t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post.searchText=e,t.post.selectedOption=o,t.post.search=!0,t.post.loadable=!0,t.post.number=0,s.getPostsBySearchtext(r,i,0,e,o).then(function(e){t.posts=e.data})},t.catagory=r,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.loadMorePost=function(){1==t.post.search?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,s.getPostsBySearchtext(r,i,t.post.number++,searchText,selectedOption).then(function(e){n(e.data)})):s.getPostsByCatagory(r,i,t.post.number++).then(function(e){n(e.data)})},t.savePost=function(e){a.watchThisPost(e)}}]).controller("CatPostDetailCtrl",["$scope","serverAddress","$ionicSlideBoxDelegate","viewFullScreenModal","$ionicScrollDelegate","$sce","$state","$filter","googleMapFactory","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,s,a,n,i,r,c,l,d,u){e.serverAddress=t;var g=l.postId;d.getPostById(g).then(function(t){e.post=t.data,t.data.attached_images.length>0&&(e.containsImage=!0,e.oldImages=t.data.attached_images.split(","))}),e.jobListing=!0,e.savePost=function(e){u.watchThisPost(e)},e.$on("$ionicView.enter",function(){e.input={hasError:!1}}),e.gMapLoaded=!1,c.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){}),e.viewFullScreen=function(t){s.init(e,e.oldImages).then(function(o){e.viewFullScreenModal=o,e.modalImages=e.oldImages,e.viewFullScreenModal.show().then(function(){e.active=t})})}}]).controller("userProfileCtrl",["$scope","serverAddress","imageUploader","$cordovaCamera","$cordovaFileTransfer","$ionicScrollDelegate","$state","$window","userAuthServices","$ionicHistory",function(e,t,o,s,a,n,i,r,c,l){function d(){e.userLoggedIn=!0,"undefined"==typeof e.postType?u():"watchedPosts"==e.postType?g():"myPosts"==e.postType&&u()}e.serverAddress=t,console.log("logged in "+c.isUserLoggedIn()),e.$on("$ionicView.enter",function(){e.userLoggedIn=!1,c.isUserLoggedIn()?d():(console.log("not logged in"),c.authenticateThisUser(e).then(function(e){d(),c.userLoggedIn()},function(e){l.goBack()}))});var u=function(){e.posts=c.getUserPosts(),e.userDetails=c.getUserDetails();var o=e.userDetails.profilePic;"https"==o.substring(0,5)?e.profilePic=e.userDetails.profilePic:e.profilePic=t+"/userProfilePics/"+e.userDetails.profilePic,e.postType="myPosts",e.catagory="userProfile",e.postOperations={removeable:!0,saveable:!1,removeWatch:!1},e.remove=function(e){c.deletePost(e)},n.scrollTop()},g=function(){c.getWatchedPosts().then(function(t){e.postType="watchedPosts",e.posts=t.data}),e.remove=function(t){c.removeWatchedPost(t).then(function(){e.posts.splice(e.posts.indexOf(t),1)})},n.scrollTop()};e.tabButtons={myPostsTab:u,watchingTab:g},e.logUserOut=function(){c.logUserOut().then(function(){i.go("tab.dash")},function(){})},e.images=Array(),o.init.setMaxImagesAllowed(1),e.removeImageFromView=function(t){o.removeImageFromView(t,e.images)},e.showActionSheet=function(s){var a=c.getUserDetails().uid;o.showActionSheet(s,!0).then(function(s){console.log(s),o.uploadProfilePic(s,a).then(function(o){e.profilePic=t+"/userProfilePics/"+o.newFileName})})},e.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("myPostDetailCtrl",["$filter","serverAddress","$ionicPopup","$scope","viewFullScreenModal","googleMapFactory","$stateParams","userAuthServices","kchahiyoServices","$ionicHistory","$state","imageUploader",function(e,t,o,s,a,n,i,r,c,l,d,u){s.editing=!1,s.editable=!0,s.serverAddress=t;var g=i.postId;s.gMapLoaded=!1,s.images=Array(),s.oldImages=Array(),n.load.then(function(e){console.log("successfully loadeed"),s.gMapLoaded=!0},function(e){});var p=r.getPostById(g);s.post=p,p.attached_images.length>0?(s.oldImages=p.attached_images.split(","),console.log(JSON.stringify(s.oldImages)),s.containsImage=!0,u.init.setMaxImagesAllowed(5-s.oldImages.length),a.init(s,s.oldImages)):u.init.setMaxImagesAllowed(5),s.showActionSheet=function(e){u.showActionSheet(e).then(function(e){for(console.log("here I am");e.length>0;)s.images.push(e.pop())})},s.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o},s.postOperations={editPost:function(t){s.post.content=e("addNewLine")(s.post.content),s.editing=!0},cancelEdit:function(e){s.editing=!1},savePost:function(e){var t=s.post,n=s.images,i=s.oldImages,r="uploads";c.savePost(t).then(function(e){console.log(e),u.uploadImages(t.id,n,i,r).then(function(){s.uploadsCompleted=!0,a.init(s,s.oldImages),o.alert({type:"button-assertive",title:"Success",template:"Post has been saved successfully!"}),s.editing=!1})},function(e){o.alert({title:"Error",template:"Error, try saving again"})})},deletePost:function(){o.show({title:"Confirmation",template:"Do you want to delete this posting?",buttons:[{type:"button-assertive",text:"Yes",onTap:function(e){r.deletePost(s.post).then(function(e){l.goBack()},function(e){})}},{text:"No"}]})},removeImageFromServer:function(e,t){u.removeFileFromServer(t,e).then(function(t){console.log("done removal"+t.data),s.oldImages.splice(s.oldImages.indexOf(e),1)})},removeImageFromDevice:function(e){u.removeImageFromDevice(e,s.images)}}}]).controller("myWatchedPostDetailCtrl",["$scope","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,s){var a=o.id;e.watched=!0,e.post=t.getWatchedPostDetailsById(a),console.log(e.post),e.gMapLoaded=!1,s.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){})}]).controller("AddPostCtrl",["$q","$scope","$ionicModal","$state","$ionicActionSheet","userAuthServices","imageUploader","kchahiyoServices","googleMapFactory","$ionicPopup","$ionicHistory","$cordovaFile","$cordovaImagePicker","$cordovaFileTransfer","$cordovaCamera",function(e,t,o,s,a,n,i,r,c,l,d,u,g,p,f){var h=n.getStateAndCity();t.stateName=h.state,t.cityName=h.city,t.images=Array(),r.getCitiesByState(t.stateName).then(function(e){t.counties=e.data},function(){}),o.fromTemplateUrl("templates/googlePlaces.html",{scope:t}).then(function(e){t.googlePlacesModal=e}),t.closeButtonClicked=function(){t.googlePlacesModal.hide()};var m=function(){c.load.then(function(e){t.gMapLoaded=!0},function(e){})},y=function(){m();var e=n.getUserDetails();t.post={username:e.first_name+" "+e.last_name,email:e.email,uniqueId:e.unique_id,location:{},doNotUseFullAddress:!1},t.userLoggedIn=!0};t.$on("$ionicView.enter",function(){n.authenticateThisUser(t).then(function(e){y()},function(e){d.goBack()})}),t.postOperations={catagorySelected:function(e){""!=e&&r.getSubCatagories(e).then(function(e){t.subCatagories=e},function(e){})},zipCodeUpdated:function(e){5==e.toString().length&&(t.cityLoading=!0,r.getCityByZip(e).then(function(e){t.post.location.city=e.data.content.city,t.post.location.post_state=e.data.content.state,t.post.location.lng=parseFloat(e.data.content.longitude),t.post.location.lat=parseFloat(e.data.content.latitude),t.cityLoading=!1},function(e){}))},savePostClicked:function(o){function s(e){r.insertPost(e).then(function(e){a(e.data).then(function(){l.alert({title:"Success",template:"Successfully Posted!",buttons:[{text:"ok",onTap:function(){d.goBack()}}]})})},function(e){l.alert({title:"Failure",template:"Error has occured, try again!"})})}function a(o){var s=e.defer(),a=t.images,n=Array();return i.uploadImages(o,a,n,"uploads").then(function(){t.uploadsCompleted=!0,s.resolve("upload completed")},function(e){s.reject("error occured during upload")}),s.promise}if("undefined"!=typeof o.$error.required&&o.$error.required.length>0)t.input={hasError:!0};else if("undefined"==typeof t.post.place)t.invalidAddress=!0;else if(t.post.doNotUseFullAddress)console.log(t.post);else{var n=t.post.place,c=t.post.place.formatted_address.split(",");t.post.location={lat:n.geometry.location.lat(),lng:n.geometry.location.lng(),street_address:c[0].trim(),city:c[1].trim(),post_state:c[2].trim().split(" ")[0],zip_code:parseInt(c[2].trim().split(" ")[1])},s(t.post)}}},i.init.setMaxImagesAllowed(5),t.removeImageFromView=function(e){i.removeImageFromView(e,t.images)},t.showActionSheet=function(e){i.showActionSheet(e).then(function(e){for(;e.length>0;)t.images.push(e.pop())})},t.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("AboutCtrl",["$scope",function(e){}]);