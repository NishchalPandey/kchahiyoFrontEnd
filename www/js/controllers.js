angular.module("starter.controllers",["filterModule"]).controller("chooseStateCtrl",["$scope","$state","kchahiyoServices","userAuthServices","$stateParams",function(e,t,o,a,s){if(a.isSetStateAndCity()&&"false"==s.resetLocation){var n=a.getStateAndCity();return void t.go("tab.dash",{state:n.state,stateShort:n.state_abbr,city:n.city})}e.country="USA",e.stateChanged=function(e){t.go("chooseCity",{stateName:e})},o.getStatesByCountry(e.country).then(function(t){e.states=t.data,e.dataLoaded=!0})}]).controller("chooseCityCtrl",["$scope","$state","$stateParams","kchahiyoServices",function(e,t,o,a){e.cityChanged=function(e,o){t.go("tab.dash",{state:e,city:o})},e.stateName=o.stateName,e.city={},a.getCitiesByState(e.stateName).then(function(t){e.counties=t.data},function(){})}]).controller("DashCtrl",["$scope","facebookServices","$state","$sce","$ionicModal","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,a,s,n,i,r){return e.state=i.state,e.city=i.city,""===e.state||""===e.city?void o.go("chooseState"):void n.setStateAndCity(e.state,e.city)}]).controller("CatPostCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,a,s){function n(e){if(0===e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}var i=s.getStateAndCity(),r=o.catagory;t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post={searchText:void 0==e?"":e.trim(),selectedOption:o,search:!0,loadable:!0,number:0},t.posts=[],t.loadMorePost()},t.catagory=r,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.loadMorePost=function(){t.post.search===!0?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,a.getPostsBySearchtext(r,i,t.post.number++,searchText,selectedOption).then(function(e){n(e.data)})):a.getPostsByCatagory(r,i,t.post.number++).then(function(e){n(e.data)})},a.getPostCatagories().then(function(e){t.catagories=e.catagories,t.catAndSubCat=e.catAndSubCat}),t.savePost=function(e){s.watchThisPost(e)}}]).controller("CatPostDetailCtrl",["$scope","serverAddress","$ionicSlideBoxDelegate","viewFullScreenModal","$ionicScrollDelegate","$sce","$state","$filter","googleMapFactory","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,a,s,n,i,r,c,l,d,u){e.serverAddress=t;var g=l.postId;d.getPostById(g).then(function(t){e.post=t.data,t.data.attached_images.length>0&&(e.containsImage=!0,e.oldImages=t.data.attached_images.split(","))}),e.jobListing=!0,e.savePost=function(e){u.watchThisPost(e)},e.$on("$ionicView.enter",function(){e.input={hasError:!1}}),e.gMapLoaded=!1,c.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){}),e.viewFullScreen=function(t){a.init(e,e.oldImages).then(function(o){e.viewFullScreenModal=o,e.modalImages=e.oldImages,e.viewFullScreenModal.show().then(function(){e.active=t})})}}]).controller("userProfileCtrl",["$scope","kchahiyoServices","serverAddress","imageUploader","$filter","$cordovaCamera","$cordovaFileTransfer","$ionicScrollDelegate","$state","$window","userAuthServices","$ionicHistory",function(e,t,o,a,s,n,i,r,c,l,d,u){function g(){e.userLoggedIn=!0,"undefined"==typeof e.postType?p():"watchedPosts"==e.postType?f():"myPosts"==e.postType&&p()}e.serverAddress=o,console.log("logged in "+d.isUserLoggedIn()),e.catagory="Jobs",e.$on("$ionicView.enter",function(){e.userLoggedIn=!1,d.isUserLoggedIn()&&!d.isUserPostsChanged()?g():(console.log("not logged in"),d.authenticateThisUser(e).then(function(e){g(),d.setUserPostsChanged(!1),d.userLoggedIn()},function(e){u.goBack()}))}),e.search=function(t,o){var a={};"Title"==o?a.title=t:"Zip"==o?a.post_zip=t:"City"==o?a.city=t:"Sub Catagory"==$selectedOption&&(a.sub_catagory=t),e.posts=s("filter")(d.getUserPosts(),a)};var p=function(){e.posts=d.getUserPosts(),e.userDetails=d.getUserDetails();var t=e.userDetails.profilePic;"https"==t.substring(0,5)?e.profilePic=e.userDetails.profilePic:e.profilePic=o+"/userProfilePics/"+e.userDetails.profilePic,e.postType="myPosts",e.catagory="userProfile",e.postOperations={removeable:!0,saveable:!1,removeWatch:!1},e.remove=function(e){d.deletePost(e)},r.scrollTop()},f=function(){d.getWatchedPosts().then(function(t){e.postType="watchedPosts",e.posts=t.data}),e.remove=function(t){d.removeWatchedPost(t).then(function(){e.posts.splice(e.posts.indexOf(t),1)})},r.scrollTop()};e.tabButtons={myPostsTab:p,watchingTab:f},e.logUserOut=function(){d.logUserOut().then(function(){c.go("tab.dash")},function(){})},t.getPostCatagories().then(function(t){e.catagories=t.catagories,e.catAndSubCat=t.catAndSubCat});var m=a.imageUpldr();e.showActionSheet=function(){m.init(1,null,null,"userProfilePics");var t=d.getUserDetails().uid;m.showActionSheet().then(function(s){a.uploadProfilePic(s,t).then(function(t){e.profilePic=o+"/userProfilePics/"+t.newFileName})})},e.removeImageFromView=function(t){a.removeImageFromView(t,e.images)},e.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("myPostDetailCtrl",["$filter","serverAddress","$ionicPopup","$scope","viewFullScreenModal","googleMapFactory","$stateParams","userAuthServices","kchahiyoServices","$ionicHistory","$state","imageUploader",function(e,t,o,a,s,n,i,r,c,l,d,u){a.editing=!1;a.editable=!0,a.serverAddress=t;var g=i.postId;a.gMapLoaded=!1,a.images=[],a.viewFullScreen=function(e){s.init(a,a.oldImages).then(function(t){a.viewFullScreenModal=t,a.modalImages=a.oldImages,a.viewFullScreenModal.show().then(function(){a.active=e})})},n.load.then(function(e){console.log("successfully loadeed"),a.gMapLoaded=!0},function(e){});var p=r.getPostById(g);a.post=p,p.attached_images.length>0?(a.oldImages=p.attached_images.split(","),console.log(JSON.stringify(a.oldImages)),a.containsImage=!0,imgUpldr=u.imageUpldr(),imgUpldr.init(5,a.oldImages,a.images,"uploads"),s.init(a,a.oldImages)):(imgUpldr=u.imageUpldr(),imgUpldr.init(5,null,a.images,"uploads")),a.showActionSheet=imgUpldr.showActionSheet,a.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o},a.postOperations={editPost:function(t){a.post.content=e("addNewLine")(a.post.content),a.editing=!0},cancelEdit:function(e){a.editing=!1},savePost:function(e){var t=a.post,n=a.images,i=a.oldImages,r="uploads";c.savePost(t).then(function(e){console.log(e),u.uploadImages(t.id,n,i,r).then(function(){a.uploadsCompleted=!0,s.init(a,a.oldImages),o.alert({type:"button-assertive",title:"Success",template:"Post has been saved successfully!"}),a.editing=!1})},function(e){o.alert({title:"Error",template:"Error, try saving again"})})},deletePost:function(){o.show({title:"Confirmation",template:"Do you want to delete this posting?",buttons:[{type:"button-assertive",text:"Yes",onTap:function(e){r.deletePost(a.post).then(function(e){l.goBack()},function(e){})}},{text:"No"}]})},removeImageFromServer:function(e,t){imgUpldr.removeFileFromServer(t,e).then(function(e){console.log("done removal"+e.data)})},removeImageFromDevice:function(e){u.removeImageFromDevice(e,a.images)}}}]).controller("myWatchedPostDetailCtrl",["$scope","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,a){var s=o.id;e.watched=!0,e.post=t.getWatchedPostDetailsById(s),console.log(e.post),e.gMapLoaded=!1,a.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){})}]).controller("AddPostCtrl",["$q","$scope","$ionicModal","$state","$ionicActionSheet","userAuthServices","imageUploader","kchahiyoServices","googleMapFactory","$ionicPopup","$ionicHistory","$cordovaFile","$cordovaImagePicker","$cordovaFileTransfer","$cordovaCamera",function(e,t,o,a,s,n,i,r,c,l,d,u,g,p,f){var m=function(e){l.alert({title:"Failure",template:e})},h=n.getStateAndCity();t.stateName=h.state,t.cityName=h.city,t.images=[],r.getCitiesByState(t.stateName).then(function(e){t.counties=e.data},function(){}),o.fromTemplateUrl("templates/googlePlaces.html",{scope:t}).then(function(e){t.googlePlacesModal=e}),t.closeButtonClicked=function(){t.googlePlacesModal.hide()};var v=function(){c.load.then(function(e){t.gMapLoaded=!0},function(e){})},y=function(){v();var e=n.getUserDetails();t.post={username:e.first_name+" "+e.last_name,email:e.email,uniqueId:e.unique_id,location:{},catagory:"",hideUserDetails:!1,doNotUseFullAddress:!1},r.getPostCatagories().then(function(e){t.catagories=e.catagories,t.catAndSubCat=e.catAndSubCat}),t.userLoggedIn=!0};t.$on("$ionicView.enter",function(){n.authenticateThisUser(t).then(function(e){y()},function(e){d.goBack()})}),t.postOperations={zipCodeUpdated:function(e){5==e.toString().length&&(t.cityLoading=!0,r.getCityByZip(e).then(function(e){t.post.location.city=e.data.content.city,t.post.location.post_state=e.data.content.state,t.post.location.lng=parseFloat(e.data.content.longitude),t.post.location.lat=parseFloat(e.data.content.latitude),t.cityLoading=!1},function(e){}))},savePostClicked:function(o){function a(e){r.insertPost(e).then(function(e){var t=e.data.status;"success"==t?s(e.data.content).then(function(){l.alert({title:"Success",template:"Successfully Posted!",buttons:[{text:"ok",onTap:function(){d.goBack()}}]}),n.setUserPostsChanged(!0)}):m(e.data.content)},function(e){m(e)})}function s(o){var a=e.defer(),s=t.images,n=[];return i.uploadImages(o,s,n,"uploads").then(function(){t.uploadsCompleted=!0,a.resolve("upload completed")},function(e){a.reject("error occured during upload")}),a.promise}if("undefined"!=typeof o.$error.required&&o.$error.required.length>0)t.input={hasError:!0};else if("undefined"==typeof t.post.place)t.invalidAddress=!0;else if(t.post.doNotUseFullAddress)console.log(t.post);else{var c=t.post.place,u=t.post.place.formatted_address.split(",");t.post.location={lat:c.geometry.location.lat(),lng:c.geometry.location.lng(),street_address:u[0].trim(),city:u[1].trim(),post_state:u[2].trim().split(" ")[0],zip_code:parseInt(u[2].trim().split(" ")[1])},a(t.post)}}};var P=i.imageUpldr();P.init(5,null,t.images,"uploads"),t.removeImageFromView=function(e){P.removeImageFromView(e)},t.showActionSheet=P.showActionSheet,t.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("AboutCtrl",["$scope",function(e){}]);