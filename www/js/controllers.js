angular.module("starter.controllers",["filterModule"]).controller("chooseStateCtrl",["$scope","$state","kchahiyoServices","userAuthServices","$stateParams",function(e,t,o,a,s){if(a.isSetStateAndCity()&&"false"==s.resetLocation){var n=a.getStateAndCity();return void t.go("tab.dash",{state:n.state,stateShort:n.state_abbr,city:n.city})}e.country="USA",e.stateChanged=function(e){t.go("chooseCity",{stateName:e})},o.getStatesByCountry(e.country).then(function(t){e.states=t.data,e.dataLoaded=!0})}]).controller("chooseCityCtrl",["$scope","$state","$stateParams","kchahiyoServices",function(e,t,o,a){e.cityChanged=function(e,o){t.go("tab.dash",{state:e,city:o})},e.stateName=o.stateName,e.city={},a.getCitiesByState(e.stateName).then(function(t){e.counties=t.data},function(){})}]).controller("DashCtrl",["$scope","facebookServices","$state","$sce","$ionicModal","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,a,s,n,i,r){return e.state=i.state,e.city=i.city,""===e.state||""===e.city?void o.go("chooseState"):(n.setStateAndCity(e.state,e.city),void r.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){}))}]).controller("CatPostCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,a,s){function n(e){for(var o in e)t.posts.push(e[o])}t.post={number:0,loadable:!0},t.posts=[];var i=s.getStateAndCity(),r=o.catagory;t.catagory=r,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.loadMorePost=function(){a.getPostsByCatagory(r,i,t.post.number++).then(function(e){n(e.data),0==e.data.length&&(t.post.loadable=!1),t.$broadcast("scroll.infiniteScrollComplete")})},t.savePost=function(e){s.watchThisPost(e)}}]).controller("CatPostDetailCtrl",["$scope","serverAddress","$ionicSlideBoxDelegate","viewFullScreenModal","$ionicScrollDelegate","$sce","$state","$filter","googleMapFactory","$stateParams","kchahiyoServices","userAuthServices",function(e,t,o,a,s,n,i,r,c,l,d,u){e.serverAddress=t;var g=l.postId;d.getPostById(g).then(function(t){e.post=t.data,t.data.attached_images.length>0&&(e.containsImage=!0,e.oldImages=t.data.attached_images.split(","))}),e.jobListing=!0,e.savePost=function(e){u.watchThisPost(e)},e.$on("$ionicView.enter",function(){e.input={hasError:!1}}),e.gMapLoaded=!1,c.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){}),e.viewFullScreen=function(t){a.init(e,e.oldImages).then(function(o){e.viewFullScreenModal=o,e.modalImages=e.oldImages,e.viewFullScreenModal.show().then(function(){e.active=t})})}}]).controller("userProfileCtrl",["$scope","serverAddress","imageUploader","$cordovaCamera","$cordovaFileTransfer","$ionicScrollDelegate","$state","$window","userAuthServices","$ionicHistory",function(e,t,o,a,s,n,i,r,c,l){function d(){e.userLoggedIn=!0,"undefined"==typeof e.postType?u():"watchedPosts"==e.postType?g():"myPosts"==e.postType&&u()}e.serverAddress=t,console.log("logged in "+c.isUserLoggedIn()),e.$on("$ionicView.enter",function(){e.userLoggedIn=!1,c.isUserLoggedIn()?d():(console.log("not logged in"),c.authenticateThisUser(e).then(function(e){d(),c.userLoggedIn()},function(e){l.goBack()}))});var u=function(){e.posts=c.getUserPosts(),e.userDetails=c.getUserDetails();var o=e.userDetails.profilePic;"https"==o.substring(0,5)?e.profilePic=e.userDetails.profilePic:e.profilePic=t+"/userProfilePics/"+e.userDetails.profilePic,e.postType="myPosts",e.catagory="userProfile",e.postOperations={removeable:!0,saveable:!1,removeWatch:!1},e.remove=function(e){c.deletePost(e)},n.scrollTop()},g=function(){c.getWatchedPosts().then(function(t){e.postType="watchedPosts",e.posts=t.data}),e.remove=function(t){c.removeWatchedPost(t).then(function(){e.posts.splice(e.posts.indexOf(t),1)})},n.scrollTop()};e.tabButtons={myPostsTab:u,watchingTab:g},e.logUserOut=function(){c.logUserOut().then(function(){i.go("tab.dash")},function(){})},e.images=Array(),o.init.setMaxImagesAllowed(1),e.removeImageFromView=function(t){o.removeImageFromView(t,e.images)},e.showActionSheet=function(a){var s=c.getUserDetails().uid;o.showActionSheet(a,!0).then(function(a){console.log(a),o.uploadProfilePic(a,s).then(function(o){e.profilePic=t+"/userProfilePics/"+o.newFileName})})},e.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("myPostDetailCtrl",["$filter","serverAddress","$ionicPopup","$scope","viewFullScreenModal","googleMapFactory","$stateParams","userAuthServices","kchahiyoServices","$ionicHistory","$state","imageUploader",function(e,t,o,a,s,n,i,r,c,l,d,u){a.editing=!1,a.editable=!0,a.serverAddress=t;var g=i.postId;a.gMapLoaded=!1,a.images=Array(),a.oldImages=Array(),n.load.then(function(e){console.log("successfully loadeed"),a.gMapLoaded=!0},function(e){});var p=r.getPostById(g);a.post=p,p.attached_images.length>0?(a.oldImages=p.attached_images.split(","),console.log(JSON.stringify(a.oldImages)),a.containsImage=!0,u.init.setMaxImagesAllowed(5-a.oldImages.length),s.init(a,a.oldImages)):u.init.setMaxImagesAllowed(5),a.showActionSheet=function(e){u.showActionSheet(e).then(function(e){for(console.log("here I am");e.length>0;)a.images.push(e.pop())})},a.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o},a.postOperations={editPost:function(t){a.post.content=e("addNewLine")(a.post.content),a.editing=!0},cancelEdit:function(e){a.editing=!1},savePost:function(e){var t=a.post,n=a.images,i=a.oldImages,r="uploads";c.savePost(t).then(function(e){console.log(e),u.uploadImages(t.id,n,i,r).then(function(){a.uploadsCompleted=!0,s.init(a,a.oldImages),o.alert({type:"button-assertive",title:"Success",template:"Post has been saved successfully!"}),a.editing=!1})},function(e){o.alert({title:"Error",template:"Error, try saving again"})})},deletePost:function(){o.show({title:"Confirmation",template:"Do you want to delete this posting?",buttons:[{type:"button-assertive",text:"Yes",onTap:function(e){r.deletePost(a.post).then(function(e){l.goBack()},function(e){})}},{text:"No"}]})},removeImageFromServer:function(e,t){u.removeFileFromServer(t,e).then(function(t){console.log("done removal"+t.data),a.oldImages.splice(a.oldImages.indexOf(e),1)})},removeImageFromDevice:function(e){u.removeImageFromDevice(e,a.images)}}}]).controller("myWatchedPostDetailCtrl",["$scope","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,a){var s=o.id;e.watched=!0,e.post=t.getWatchedPostDetailsById(s),console.log(e.post),e.gMapLoaded=!1,a.load.then(function(t){console.log("successfully loadeed"),e.gMapLoaded=!0},function(e){})}]).controller("AddPostCtrl",["$q","$scope","$state","$ionicActionSheet","userAuthServices","imageUploader","kchahiyoServices","googleMapFactory","$ionicPopup","$ionicHistory","$cordovaFile","$cordovaImagePicker","$cordovaFileTransfer","$cordovaCamera",function(e,t,o,a,s,n,i,r,c,l,d,u,g,p){var f=s.getStateAndCity();t.stateName=f.state,t.cityName=f.city,t.images=Array(),i.getCitiesByState(t.stateName).then(function(e){t.counties=e.data},function(){});var m=function(){r.load.then(function(e){t.gMapLoaded=!0},function(e){})},h=function(){m();var e=s.getUserDetails();t.post={username:e.first_name+" "+e.last_name,email:e.email,uniqueId:e.unique_id,location:{},doNotUseFullAddress:!1},t.userLoggedIn=!0};t.$on("$ionicView.enter",function(){s.authenticateThisUser(t).then(function(e){h()},function(e){l.goBack()})}),t.postOperations={catagorySelected:function(e){""!=e&&i.getSubCatagories(e).then(function(e){t.subCatagories=e},function(e){})},zipCodeUpdated:function(e){5==e.toString().length&&(t.cityLoading=!0,i.getCityByZip(e).then(function(e){t.post.location.city=e.data.content.city,t.post.location.post_state=e.data.content.state,t.post.location.lng=parseFloat(e.data.content.longitude),t.post.location.lat=parseFloat(e.data.content.latitude),t.cityLoading=!1},function(e){}))},savePostClicked:function(o){function a(e){i.insertPost(e).then(function(e){s(e.data).then(function(){c.alert({title:"Success",template:"Successfully Posted!",buttons:[{text:"ok",onTap:function(){l.goBack()}}]})})},function(e){c.alert({title:"Failure",template:"Error has occured, try again!"})})}function s(o){var a=e.defer(),s=t.images,i=Array();return n.uploadImages(o,s,i,"uploads").then(function(){t.uploadsCompleted=!0,a.resolve("upload completed")},function(e){a.reject("error occured during upload")}),a.promise}if("undefined"!=typeof o.$error.required&&o.$error.required.length>0)t.input={hasError:!0};else if("undefined"==typeof t.post.place)t.invalidAddress=!0;else if(t.post.doNotUseFullAddress)console.log(t.post);else{var r=t.post.place,d=t.post.place.formatted_address.split(",");t.post.location={lat:r.geometry.location.lat(),lng:r.geometry.location.lng(),street_address:d[0].trim(),city:d[1].trim(),post_state:d[2].trim().split(" ")[0],zip_code:parseInt(d[2].trim().split(" ")[1])},a(t.post)}}},n.init.setMaxImagesAllowed(5),t.removeImageFromView=function(e){n.removeImageFromView(e,t.images)},t.showActionSheet=function(e){n.showActionSheet(e).then(function(e){for(;e.length>0;)t.images.push(e.pop())})},t.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("AboutCtrl",["$scope",function(e){}]);