angular.module("starter.controllers",["filterModule"]).controller("chooseCountryCtrl",["$scope","$state","configs","$ionicSlideBoxDelegate","$ionicPlatform","userAuthServices","$timeout",function(e,t,o,s,a,n,i){var r=o.country();if(e.selectedCountry=r,e.countrySelected=function(e){var s=o.geoDivision[e][0],a="choose"+s[0].toUpperCase()+s.substring(1);localStorage.setItem("country",e),t.go(a)},e.slideHasChanged=function(t){r=o.flags[t],e.selectedCountry=r,localStorage.setItem("country",r)},n.isSetStateAndCity()===!0){n.getStateAndCity();return void t.go("tab.dash")}var c=function(){return o.flags.indexOf(r)};a.ready().then(function(e){s.slide(c())},function(e){})}]).controller("chooseStateCtrl",["$scope","$state","kchahiyoServices","userAuthServices","$stateParams","configs","$rootScope",function(e,t,o,s,a,n,i){i.$broadcast("loadingStarted");var r=n.country();e.stateChanged=function(e){localStorage.setItem("state",e),t.go("chooseCity",{stateName:e})},o.getStatesByCountry(r).then(function(t){i.$broadcast("loadingCompleted"),e.states=t.data,e.dataLoaded=!0})}]).controller("chooseCityCtrl",["$scope","$state","$stateParams","kchahiyoServices","configs","$rootScope",function(e,t,o,s,a,n){e.searchText="",e.cityChanged=function(e){localStorage.setItem("city",e),t.go("tab.dash")},e.stateName=o.stateName,e.city={};var i=a.country();-1!=a.geoDivision[i].indexOf("state")?s.getCitiesByState(e.stateName).then(function(t){e.counties=t.data,e.loaded=!0}):s.getCitiesByCountry(i).then(function(t){n.$broadcast("loadingCompleted"),e.counties=t.data},function(e){alert(e.data)})}]).controller("DashCtrl",["$scope","$state","configs","kchahiyoServices","$ionicLoading","$rootScope","geoServices",function(e,t,o,s,a,n,i){return n.$broadcast("loadingStarted"),e.chooseCountry=function(){i.resetGeoParameters(),t.go("chooseCountry")},""===e.state||""===e.city?void t.go("chooseCountry"):(s.getPostCatagories().then(function(t){n.$broadcast("loadingCompleted"),e.catagoryNames=t.catagories,e.getDashboardIconName=function(e){return t.catagoryObject[e].iconName},e.getCatagoryPageHref=function(e){return t.catagoryObject[e].href}}),void(e.getBreadCrumb=function(){var e=" ",t=o.country();return o.geoDivision[t].forEach(function(t){e+=localStorage.getItem(t)+", "}),e.substring(0,e.length-2)}))}]).controller("CatPostCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices","configs","$rootScope",function(e,t,o,s,a,n,i){function r(e){if(0===e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}i.$broadcast("loadingStarted");var c=a.getStateAndCity(),l=o.catagory;t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post={searchText:void 0===e?"":e.trim(),selectedOption:o,search:!0,loadable:!0,number:0},t.posts=[],t.loadMorePost()},t.catagory=l,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.filterDisplaySwitch=function(e){var t=localStorage.getItem("country");return-1!=n.filter[e].indexOf(t)?!0:void 0},t.loadMorePost=function(){t.post.search===!0?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,s.getPostsBySearchtext(l,c,t.post.number++,searchText,selectedOption).then(function(e){i.$broadcast("loadingCompleted"),r(e.data)},function(e){})):s.getPostsByCatagory(l,c,t.post.number++).then(function(e){i.$broadcast("loadingCompleted"),r(e.data)})},t.doRefresh=function(){s.getPostsByCatagory(l,c,0).then(function(e){t.posts=e.data})["finally"](function(){t.$broadcast("scroll.refreshComplete")})},s.getPostCatagories().then(function(e){t.catagories=e.catagories,t.subCatagories=Object.keys(e.subCatagories[l].subCatagories)},function(e){}),t.savePost=function(e){a.watchThisPost(e)}}]).controller("CatPostDetailCtrl",["$scope","$ionicModal","messengerService","serverAddress","$ionicSlideBoxDelegate","viewFullScreenModal","$ionicScrollDelegate","$sce","userAuthServices","$state","$filter","googleMapFactory","$stateParams","kchahiyoServices","userAuthServices","configs",function(e,t,o,s,a,n,i,r,c,l,u,d,g,p,c,f){e.serverAddress=s,e.unit=f.currencyUnit[f.country()];var h=g.postId,m=localStorage.getItem("userId");e.posterId,e.message={},p.getPostById(h).then(function(t){e.post=t.data,t.data.attached_images.length>0&&(e.containsImage=!0,e.oldImages=t.data.attached_images.split(","))}),e.getUserPic=function(t){e.posterId=t.userId,e.postId=t.id;var o=t.profilePic,a=t.hide_user_details;return"1"==a?s+"/images/Anonymous_emblem.svg.png":null!==o?"https"==o.substring(0,5)?o:s+"/userProfilePics/thumbs/thumb_"+o:void 0},o.init({serverAddress:s}),e.messengerServiceInitiated=function(){c.authenticateThisUser(e).then(function(t){e.showMessageSendButton=!0},function(){}),t.fromTemplateUrl("templates/messagingService/messageModal.html",{scope:e,backdropClickToClose:!0}).then(function(t){function s(t){e.message.content="",t.hide()}t.show(),e.closeButtonClicked=function(){s(t)},e.sendMessageEvent=function(){o.sendMessage({post_id:e.postId,post_title:e.post.title,sender_id:m,receiver_id:e.posterId,content:e.message.content}).then(function(e){s(t)})}})},e.jobListing=!0,e.savePost=function(e){c.watchThisPost(e)},e.$on("$ionicView.enter",function(){e.input={hasError:!1}}),e.gMapLoaded=!1,d.load.then(function(t){e.gMapLoaded=!0},function(e){}),e.viewFullScreen=function(t){n.init(e,e.oldImages).then(function(o){e.viewFullScreenModal=o,e.modalImages=e.oldImages,e.viewFullScreenModal.show().then(function(){e.active=t})})}}]).controller("watchedPostsCtrl",["userAuthServices","$scope",function(e,t){e.getWatchedPosts().then(function(e){t.posts=e.data,t.postType="watchedPosts",t.catagory="userProfile"})}]).controller("userMessagesCtrl",["messengerService","$scope","serverAddress",function(e,t,o){e.init({serverAddress:o}),e.readUserMessages({user_id:localStorage.getItem("userId")}).then(function(e){function o(e,t,o){return o.indexOf(e)===t}var s=e.data.content,a=s.filter(o);t.posts=a})}]).controller("messageDetailsCtrl",["$stateParams","messengerService","$scope","serverAddress",function(e,t,o,s){var a=e.title;t.init({serverAddress:s}),t.readUserMessages({user_id:localStorage.getItem("userId")}).then(function(e){var t=new Array;e.data.content.forEach(function(e){e.post_title===a&&t.push(e)}),o.posts=t})}]).controller("userProfileCtrl",["$scope","messengerService","serverAddress","kchahiyoServices","serverAddress","imageUploader","$filter","$cordovaCamera","$cordovaFileTransfer","$ionicScrollDelegate","$state","$window","userAuthServices","$ionicHistory",function(e,t,o,s,o,a,n,i,r,c,l,u,d,g){function p(){e.userLoggedIn=!0,"undefined"==typeof e.postType?f():"watchedPosts"==e.postType?loadWatchedPosts():"myPosts"==e.postType?f():"myMessages"==e.postType&&loadUserMessages()}e.serverAddress=o,e.catagory="Jobs",e.userLoggedIn=!1,d.isUserLoggedIn()?p():d.authenticateThisUser(e).then(function(e){p(),d.userLoggedIn()},function(e){g.goBack()}),e.search=function(t,o){var s={};"Title"==o?s.title=t:"Zip"==o?s.post_zip=t:"City"==o?s.city=t:"Sub Catagory"==$selectedOption&&(s.sub_catagory=t),e.posts=n("filter")(d.getUserPosts(),s)};var f=function(){e.posts=d.getUserPosts(),e.userDetails=d.getUserDetails();var t=e.userDetails.profilePic||"";""===t?e.profilePic=!1:"https"==t.substring(0,5)?e.profilePic=t:e.profilePic=o+"/userProfilePics/"+t,e.postType="myPosts",e.catagory="userProfile",e.postOperations={removeable:!0,saveable:!1,removeWatch:!1},e.remove=function(e){d.deletePost(e).then(function(e){alert(e.data.content)},function(e){alert("Error deleting the post, try again!")})}};s.getPostCatagories().then(function(t){e.$selectedOption="Catagories",e.subCatagories=t.catagories},function(e){}),e.tabButtons={myPostsTab:function(){f(),c.scrollTop()},watchingTab:function(){loadWatchedPosts(),c.scrollTop()},messagingTab:function(){loadUserMessages(),c.scrollTop()}},e.logUserOut=function(){d.logUserOut().then(function(){l.go("tab.dash")},function(){})};var h=a.imageUpldr();e.showActionSheet=function(){h.init(1,null,null,"userProfilePics");var t=d.getUserDetails().uid;h.showActionSheet().then(function(s){e.profilePicLoading=!0,a.uploadProfilePic(s,t).then(function(t){e.profilePicLoading=!1,e.profilePic=o+"/userProfilePics/"+t.newFileName})})},e.removeImageFromView=function(t){a.removeImageFromView(t,e.images)},e.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("postDetailsCtrl",["$filter","serverAddress","$ionicPopup","$scope","viewFullScreenModal","googleMapFactory","$stateParams","userAuthServices","kchahiyoServices","$ionicHistory","$state","imageUploader","configs",function(e,t,o,s,a,n,i,r,c,l,u,d,g){function p(){s.priceFeature=!1}function f(e,t){if(p(),"undefined"!=typeof t){var t=t.trim();e[t].features.forEach(function(e){s[e+"Feature"]=!0})}}s.unit=g.currencyUnit[g.country()];var h=function(e){o.alert({title:"Status",template:e})};s.messengerServiceInitiated=function(){h("byaaam")},s.getUserPic=function(e){return null!==e?"https"===e.substring(0,5)?e:t+"/userProfilePics/thumbs/thumb_"+e:void 0},c.getPostCatagories().then(function(e){s.catagories=e.catagoriesObject;var t=e.subCatagories[s.post.catagory].subCatagories;f(t,s.post.sub_catagory)},function(e){}),s.editing=!1;s.editable=!0,s.serverAddress=t;var m=i.postId;s.gMapLoaded=!1,s.images=[],s.viewFullScreen=function(e){a.init(s,s.oldImages).then(function(t){s.viewFullScreenModal=t,s.modalImages=s.oldImages,s.viewFullScreenModal.show().then(function(){s.active=e})})},n.load.then(function(e){s.gMapLoaded=!0},function(e){});var v=r.getPostById(m);s.post=v,v.attached_images.length>0?(s.oldImages=v.attached_images.split(","),s.containsImage=!0,imgUpldr=d.imageUpldr(),imgUpldr.init(5,s.oldImages,s.images,"uploads"),a.init(s,s.oldImages)):(s.oldImages=[],imgUpldr=d.imageUpldr(),imgUpldr.init(5,null,s.images,"uploads")),s.showActionSheet=imgUpldr.showActionSheet,s.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o},s.postOperations={editPost:function(t){s.post.content=e("addNewLine")(s.post.content),s.editing=!0},cancelEdit:function(e){s.editing=!1},savePost:function(e){var t=s.post,n=s.images,i=s.oldImages,l="uploads";c.savePost(t).then(function(e){d.uploadImages(t.id,n,i,l).then(function(){r.updatePostImages(t.id,i),s.uploadsCompleted=!0,a.init(s,s.oldImages),o.alert({type:"button-assertive",title:"Success",template:"Post has been saved successfully!"}),r.setUserPostsChanged(!0),s.editing=!1})},function(e){o.alert({title:"Error",template:"Error, try saving again"})})},deletePost:function(){o.show({title:"Confirmation",template:"Do you want to delete this posting?",buttons:[{type:"button-assertive",text:"Yes",onTap:function(e){r.deletePost(s.post).then(function(e){h(e.data.content),l.goBack()},function(e){h("Error deleting the post, try again!")})}},{text:"No"}]})},removeImageFromServer:function(e,t){imgUpldr.removeFileFromServer(t,e).then(function(e){})},removeImageFromDevice:function(e){d.removeImageFromDevice(e,s.images)}}}]).controller("myWatchedPostDetailCtrl",["$scope","serverAddress","viewFullScreenModal","userAuthServices","$stateParams","googleMapFactory",function(e,t,o,s,a,n){var i=a.id;e.watched=!0,e.post=s.getWatchedPostDetailsById(i),e.oldImages=[],e.serverAddress=t,e.post.attached_images.length>0&&(e.oldImages=e.post.attached_images.split(",")),e.gMapLoaded=!1,n.load.then(function(t){e.gMapLoaded=!0},function(e){}),e.getUserPic=function(e){return null!==e?"https"==e.substring(0,5)?e:t+"/userProfilePics/thumbs/thumb_"+e:void 0},e.viewFullScreen=function(t){o.init(e,e.oldImages).then(function(o){e.viewFullScreenModal=o,e.modalImages=e.oldImages,e.viewFullScreenModal.show().then(function(){e.active=t})})}}]).controller("AddPostCtrl",["$q","$scope","configs","$ionicModal","$state","$ionicActionSheet","userAuthServices","imageUploader","kchahiyoServices","googleMapFactory","$ionicPopup","$ionicHistory","$cordovaFile","$cordovaImagePicker","$cordovaFileTransfer","$cordovaCamera","$rootScope",function(e,t,o,s,a,n,i,r,c,l,u,d,g,p,f,h,m){function v(){t.priceFeature=!1}function y(e,o){if(v(),"undefined"!=typeof o){var o=o.trim();e[o].features.forEach(function(e){t[e+"Feature"]=!0})}}-1!=o.features.fullAddressFeature.indexOf(o.country())&&(t.fullAddressFeature=!0),t.images=[];var b=function(e){u.alert({title:"Failure",template:e})},P=i.getStateAndCity();t.stateName=P.state,t.cityName=P.city,c.getCitiesByState(t.stateName).then(function(e){t.counties=e.data}),s.fromTemplateUrl("templates/googlePlaces.html",{scope:t}).then(function(e){t.googlePlacesModal=e}),t.closeButtonClicked=function(){t.googlePlacesModal.hide()};var C=function(){t.gMapLoaded=!1,l.load.then(function(e){t.gMapLoaded=!0},function(e){})},S=function(){C();var e=i.getUserDetails();t.post={username:e.first_name+" "+e.last_name,email:e.email,uniqueId:e.unique_id,location:{},catagory:"",hideUserDetails:!1,doNotUseFullAddress:!1},c.getPostCatagories().then(function(e){t.catagories=e.catagories;var o;t.onCatagoryChange=function(s){o=e.subCatagories[s].subCatagories,t.subCatagories=Object.keys(o)},t.onSubCatagoryChange=function(e){y(o,e)}},function(e){}),t.userLoggedIn=!0};t.$on("$ionicView.enter",function(){i.authenticateThisUser(t).then(function(e){S()},function(e){d.goBack()})}),t.postOperations={zipCodeUpdated:function(e){5==e.toString().length&&(t.cityLoading=!0,c.getCityByZip(e).then(function(e){t.post.location.city=e.data.content.city,t.post.location.post_state=e.data.content.state,t.post.location.lng=parseFloat(e.data.content.longitude),t.post.location.lat=parseFloat(e.data.content.latitude),t.cityLoading=!1},function(e){}))},savePostClicked:function(s){function a(e){return m.$on("loadingStarted"),c.insertPost(e).then(function(e){var t=e.data.status;"success"==t?n(e.data.content).then(function(){u.alert({title:"Success",template:"Successfully Posted!",buttons:[{text:"ok",onTap:function(){d.goBack()}}]}),i.setUserPostsChanged(!0)}):b(e.data.content),m.$on("loadingCompleted")},function(e){m.$on("loadingCompleted"),b(e)}),!1}function n(o){var s=e.defer(),a=t.images;if(0==a.length)s.resolve("no images to upload");else{var n=[];r.uploadImages(o,a,n,"uploads").then(function(){t.uploadsCompleted=!0,s.resolve("upload completed")},function(e){s.reject("error occured during upload")})}return s.promise}if("undefined"!=typeof s.$error.required&&s.$error.required.length>0)return t.input={hasError:!0},!0;if("undefined"!=typeof t.post.place||t.post.doNotUseFullAddress)if(t.post.doNotUseFullAddress)a(t.post);else if("USA"==o.country()){var l=t.post.place;if(void 0!=t.post.place.formatted_address){var g=t.post.place.formatted_address.split(",");t.post.location={lat:l.geometry.location.lat(),lng:l.geometry.location.lng(),street_address:g[0].trim(),city:g[1].trim(),post_state:g[2].trim().split(" ")[0],zip_code:parseInt(g[2].trim().split(" ")[1]),place_id:l.place_id},a(t.post)}}else{var l=t.post.place;if(void 0!=t.post.place.formatted_address){var g=t.post.place.formatted_address;t.post.location={lat:l.geometry.location.lat(),lng:l.geometry.location.lng(),street_address:g,city:"",post_state:"",zip_code:"",place_id:l.place_id},a(t.post)}}else t.invalidAddress=!0}};var $=r.imageUpldr();$.init(5,null,t.images,"uploads"),t.removeImageFromView=function(e){$.removeImageFromView(e)},t.showActionSheet=$.showActionSheet,t.urlForImage=function(e){var t=e.substr(e.lastIndexOf("/")+1),o=cordova.file.dataDirectory+"uploads/"+t;return o}}]).controller("AboutCtrl",["$scope",function(e){}]).controller("itemSalesCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices","configs","serverAddress","$ionicLoading",function(e,t,o,s,a,n,i,r){function c(e){if(0===e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}var l=a.getStateAndCity(),u="Item Sales";t.searchtext="";var d=n.country();t.unit=n.currencyUnit[d],t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post={searchText:void 0==e?"":e.trim(),selectedOption:void 0==o?"Title":o,search:!0,loadable:!0,number:0},t.posts=[],t.loadMorePost()},t.catagory=u,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.filterDisplaySwitch=function(e){var t=localStorage.getItem("country");return-1!=n.filter[e].indexOf(t)?!0:void 0},t.loadMorePost=function(){t.post.search===!0?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,s.getPostsBySearchtext(u,l,t.post.number++,searchText,selectedOption).then(function(e){c(e.data)})):s.getPostsByCatagory(u,l,t.post.number++).then(function(e){c(e.data)})},t.doRefresh=function(){s.getPostsByCatagory(u,l,0).then(function(e){t.posts=e.data})["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.getTitleImage=function(e){if(0!=e.attached_images.trim().length){var t=e.attached_images.split(","),o=e.title_image;return i+"/uploads/"+t[o]}return i+"/images/no-image-available.png"},t.savePost=function(e){a.watchThisPost(e)},s.getPostCatagories().then(function(e){t.catagories=e.catagories,t.subCatagories=Object.keys(e.subCatagories[u].subCatagories)},function(e){})}]).controller("postsWithThumbnailCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices","configs","serverAddress",function(e,t,o,s,a,n,i){function r(e){if(0===e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}var c=a.getStateAndCity(),l=o.catagory,u=n.country();t.unit=n.currencyUnit[u],t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post={searchText:void 0==e?"":e.trim(),selectedOption:o,search:!0,loadable:!0,number:0},t.posts=[],t.loadMorePost()},t.catagory=l,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.filterDisplaySwitch=function(e){var t=localStorage.getItem("country");return-1!=n.filter[e].indexOf(t)?!0:void 0},t.loadMorePost=function(){t.post.search===!0?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,s.getPostsBySearchtext(l,c,t.post.number++,searchText,selectedOption).then(function(e){r(e.data)})):s.getPostsByCatagory(l,c,t.post.number++).then(function(e){r(e.data)})},t.doRefresh=function(){s.getPostsByCatagory(l,c,0).then(function(e){t.posts=e.data})["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.getTitleImage=function(e){if(0!=e.attached_images.trim().length){var t=e.attached_images.split(","),o=e.title_image;return i+"/uploads/thumbs/thumb_"+t[o]}return i+"/images/no-image-available.png"},t.savePost=function(e){a.watchThisPost(e)},s.getPostCatagories().then(function(e){t.catagories=e.catagories,t.subCatagories=Object.keys(e.subCatagories[l].subCatagories)},function(e){})}]).controller("postsWithDefaultThumbnailCtrl",["$window","$scope","$stateParams","kchahiyoServices","userAuthServices","configs","serverAddress",function(e,t,o,s,a,n,i){function r(e){if(0===e.length)t.post.loadable=!1;else{for(var o in e)t.posts.push(e[o]);t.post.loadable=!0}t.$broadcast("scroll.infiniteScrollComplete")}var c=a.getStateAndCity(),l=o.catagory,u=n.country();t.unit=n.currencyUnit[u],t.post={number:0,loadable:!0,search:!1},t.posts=[],t.search=function(e,o){t.post={searchText:void 0==e?"":e.trim(),selectedOption:o,search:!0,loadable:!0,number:0},t.posts=[],t.loadMorePost()},t.catagory=o.catagory,t.postType="catPost",t.postOperations={saveable:!0,removeable:!1},t.filterDisplaySwitch=function(e){var t=localStorage.getItem("country");return-1!=n.filter[e].indexOf(t)?!0:void 0},t.loadMorePost=function(){t.post.search===!0?(searchText=t.post.searchText,selectedOption=t.post.selectedOption,s.getPostsBySearchtext(l,c,t.post.number++,searchText,selectedOption).then(function(e){r(e.data)})):s.getPostsByCatagory(l,c,t.post.number++).then(function(e){r(e.data)})},t.doRefresh=function(){s.getPostsByCatagory(l,c,0).then(function(e){t.posts=e.data})["finally"](function(){t.$broadcast("scroll.refreshComplete")})},t.getTitleImage=function(e){return i+"/subCatagoryThumbnails/"+l.toLowerCase()+"/"+e.sub_catagory.toLowerCase()+".png"},t.savePost=function(e){a.watchThisPost(e)},s.getPostCatagories().then(function(e){t.catagories=e.catagories,t.subCatagories=Object.keys(e.subCatagories[l].subCatagories)},function(e){})}]);