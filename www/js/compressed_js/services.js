angular.module("starter.services",[]).value("serverAddress","http://localhost/kchahiyo/php").service("kchahiyoServices",["$http","$q","serverAddress","configs","$sce","$rootScope","$ionicLoading",function(e,t,o,n,r,a,i){var s=[],c=function(t,n,r,a,i){return e.get(o+"/getPosts.php",{params:{catagory:t,locationInfo:n,pageNum:r,searchText:a,selectedOption:i}}).then(function(e){return s.concat(e.data),e})};this.postEdited=!1,this.getPostsByCatagory=c,this.getPostsBySearchtext=c,this.insertPost=function(t){var r=n.country(),a=$.param({countryName:r,email:t.email,unique_id:t.uniqueId,title:t.title,content:t.content,catagory:t.catagory,sub_catagory:t.sub_catagory?t.sub_catagory.trim():"",post_near_city:t.city,post_location:t.location,post_title_image:t.titleImage?t.titleImage:"0",hide_user_details:t.hideUserDetails,item_price:t.item_price?t.item_price:"0"});return e({url:o+"/insertPost.php",method:"POST",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})},this.getCitiesByState=function(t){var r=n.country();return e.get(o+"/getCitiesByState.php",{params:{countryName:r,stateName:t||""}})},this.getCitiesByCountry=function(t){return r.trustAsResourceUrl(o),e.get(o+"/getCitiesByCountry.php?countryName="+t).then(function(e){return e},function(e){var t={data:["Butwal","Bhairahawa","Birgunj"]};return t})},this.getStatesByCountry=function(t){return e.get(o+"/getCitiesByState.php",{params:{countryName:t}})},this.getCityByZip=function(t){return e.get(o+"/getCityByZip.php",{params:{zip:t}})};this.getAddPostFeatures=function(){return e.get(o+"/getConfigs.php")},this.getPostCatagories=function(){return e.get(o+"/getConfigs.php").then(function(e){var t=e.data.postCatagories[n.country()].catagories,o=Object.keys(e.data.postCatagories[n.country()].catagories),r=e.data.postCatagories[n.country()].catagories;return{catagories:o,subCatagories:r,catagoryObject:t}},function(e){})},function(){a.$on("loadingStarted",function(){i.show()}),a.$on("loadingCompleted",function(){i.hide()})}(),this.getPostById=function(r){var a=n.country();if(0===s.length)return e.get(o+"/getPostById.php",{params:{countryName:a,id:r}});for(var i=t.defer(),c=0;c<s.length;c++)if(s[c].id==parseInt(r)){var u={};u.data=s[c],i.resolve(u)}return i.promise},this.getPostsByUserId=function(t){var r=n.country();return e.get(o+"/getPostsByUserId.php",{params:{userId:t,countryName:r}}).then(function(e){return myPosts=e.data,e},function(e){})},this.getUserPostById=function(n){if(0===s.length)return e.get(o+"/getPostById.php",{params:{id:n}});for(var r=t.defer(),a=0;a<s.length;a++)if(s[a].id==parseInt(n)){var i={};i.data=s[a],r.resolve(i)}return r.promise;var s},this.savePost=function(t){var n=$.param({operationType:"save",title:t.title,content:t.content,userId:t.userId,postId:t.id,countryName:t.tableName,post_title_image:t.titleImage?t.titleImage:"0",item_price:t.item_price?t.item_price:"0"});return e({url:o+"/postOperations.php",method:"POST",data:n,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})}}]).service("geoServices",["$window",function(e){this.resetGeoParameters=function(){null!=e.localStorage.getItem("country")&&e.localStorage.removeItem("country"),null!=e.localStorage.getItem("stateName")&&e.localStorage.removeItem("stateName"),null!=e.localStorage.getItem("cityName")&&e.localStorage.removeItem("cityName")}}]).service("userAuthServices",["$http","$q","$ionicLoading","facebookServices","$window","$ionicModal","$ionicPopup","$ionicHistory","serverAddress","configs",function(e,t,o,n,r,a,i,s,c,u){function l(o){var n=t.defer();return e({url:c+"/registerUser.php",method:"POST",data:o,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){return"success"==e.data.status?(g(e),void n.resolve("user details and post loaded")):void n.reject(e.data.content)},function(e){n.reject(e)}),n.promise}var d={facebookLogin:!1,loggedIn:!1,userPostsChanged:!1};this.updatePostImages=function(e,t){function o(e,t){for(var o=d.data.posts,n=0;n<o.length;n++)o[n].id==e&&(o[n].attached_images=t)}var n="";t.forEach(function(e){n=n+","+e}),n=n.substr(1,n.length-1),o(e,n)},this.updateUserProfilePage=function(e){d.data.userDetails.profilePic=e},this.setUserPostsChanged=function(e){d.userPostsChanged=e},this.isUserPostsChanged=function(){return d.userPostsChanged};var p=function(e){i.alert({title:e})};this.resetGeoParameters=function(){null!=r.localStorage.getItem("country")&&r.localStorage.removeItem("country"),null!=r.localStorage.getItem("stateName")&&r.localStorage.removeItem("stateName"),null!=r.localStorage.getItem("cityName")&&r.localStorage.removeItem("cityName")},this.setStateAndCity=function(e,t){r.localStorage.setItem("stateName",e),r.localStorage.setItem("cityName",t)},this.getStateAndCity=function(){var e={},t=u.country();return e.country=t,u.geoDivision[t].forEach(function(t){e[t]=localStorage.getItem(t)}),e},this.isSetStateAndCity=function(){var e=!0,t=u.country();return null===r.localStorage.getItem("country")?!1:(u.geoDivision[t].forEach(function(e){return null===r.localStorage.getItem(e)?!1:void 0}),e)},this.isFacebookLogin=function(){return d.facebookLogin},this.userLoggedIn=function(){d.loggedIn=!0},this.isUserLoggedIn=function(){return d.loggedIn},this.watchThisPost=function(t){var o=r.localStorage.getItem("userId");"undefined"==typeof d.watchedPosts&&(d.watchedPosts=Array()),d.watchedPosts.push(t);var n=u.country();e.get(c+"/postOperations.php",{params:{operationType:"watch",userId:o,postId:t.id,countryName:n}}).then(function(e){p("success"==e.data.status?"The post has been watched":e.data.content)},function(e){p(e)})},this.getWatchedPosts=function(){var t=r.localStorage.getItem("userId");return e.get(c+"/postOperations.php",{params:{operationType:"getWatchedPosts",userId:t}}).then(function(e){return d.watchedPosts=e.data,e})},this.getWatchedPostDetailsById=function(e){for(var t=d.watchedPosts.length,o=0;t>o;o++)if(d.watchedPosts[o].id==e)return d.watchedPosts[o];return null},this.removeWatchedPost=function(t,o){var n=r.localStorage.getItem("userId"),a=t.id;return e.get(c+"/postOperations.php",{params:{operationType:"removeWatchedPost",postId:a,userId:n}})},this.getUserDetails=function(){return d.data.userDetails},this.getUserPosts=function(){return d.data.posts},this.getPostById=function(e){for(var t=d.data.posts,o=0;o<t.length;o++)if(t[o].id==e)return t[o]},this.deletePost=function(t){var o=d.data.posts,n=$.param({operationType:"delete",userId:t.userId,postId:t.id,countryName:t.tableName});return o.splice(o.indexOf(t),1),e({url:c+"/postOperations.php",method:"POST",data:n,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}})},this.logUserOut=function(){var e=t.defer();return r.localStorage.setItem("userId",""),r.localStorage.setItem("unique_id",""),n.logout().then(function(){d.loggedIn=!1,p("You have been logged out!"),e.resolve("You have been logged out!")},function(t){e.resolve("You have been logged out!")}),e.promise},this.authenticateThisUser=function(i){var u=(t.defer(),function(e){var r=t.defer();return e.user={},e.loginModalButtons={},a.fromTemplateUrl("templates/tab-login.html",{scope:e}).then(function(t){e.loginModal=t,e.loginModal.show(),e.$on("loginComplete",function(t,n){o.hide(),e.loginModal.hide(),e.spinnerModal.remove()})}),e.loginModalButtons={closeButton:function(){e.$emit("loginComplete","complete"),r.reject("modal closed")},loginButton:function(){function t(t){e.$emit("loginComplete","complete"),p("You have successfully logged in!"),r.resolve("success, user data loaded")}function o(t){p("User credentials do not match!"),e.$emit("loginComplete","complete")}m(e.user).then(t,o)},fbLogin:function(){a.fromTemplateUrl("templates/spinner-modal.html",{scope:e}).then(function(t){e.spinnerModal=t,e.spinnerModal.show(),e.$on("loginComplete",function(t,o){e.spinnerModal.hide(),e.spinnerModal.remove()}),e.$on("loginError",function(t,o){e.spinnerModal.hide()})}),n.init().then(function(t){t.getLoginStatus().then(function(o){var n=o.authResponse.userID,a=o.authResponse.accessToken;f(n,a).then(function(t){return e.$emit("loginComplete","complete"),g(t),p("You have successfully logged in!"),r.resolve("user successfully logged in")},function(o){return l(t).then(function(t){return d(t,"fbUserRegister").then(function(t){e.$emit("loginComplete","complete"),g(t),r.resolve("user logged in and posts downloaded")},function(t){return e.$emit("loginError","error"),p("Registration server didn't respond, try again later! "),t})},function(t){p("error acquiring fb data, try again! "+t),e.$emit("loginError","error")})})},function(){l(t).then(function(t){return d(t,"fbUserRegister").then(function(t){e.$emit("loginComplete","complete"),g(t),r.resolve("user logged in and posts downloaded")})},function(t){p("error acquiring fb data, try again! "+t),e.$emit("loginError","error")})})},function(t){e.$emit("loginError","error")})},signUp:function(){h(e)}},r.promise}),l=function(e){return e.login().then(function(t){var o={accessToken:t.authResponse.accessToken};return e.getPublicProfile().then(function(t){return o.publicProfile=t,e.getProfilePicBig().then(function(e){return o.profilePicBig=e,o})},function(e){$scope.$emit("loginError","error")})},function(e){return $scope.$emit("loginError","error"),e})},d=function(o,n){var r=t.defer(),a=$.param({operation:n,user:o});return e({url:c+"/registerUser.php",method:"POST",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){var t=e.data.content;"success"==e.data.status?r.resolve(e):r.reject(t)},function(e){r.reject(e)}),r.promise},h=function(e){e.loginModal.hide(),a.fromTemplateUrl("templates/tab-register.html",{scope:e}).then(function(t){e.registerModal=t,e.registerModal.show(),e.user={},e.user.firstName={text:"firstName",word:/^\s*\w*\s*$/}}),e.registerModalButtons={closeButton:function(){e.registerModal.hide(),s.goBack()},register:function(t){e.user.password!=e.user.reenter_password?p("Passwords don't match"):t.$valid&&e.user.password==e.user.reenter_password?d(e.user,"createUser").then(function(t){var o=t.data;"success"==o.status?(e.registerModal.hide(),p(o.content),s.goBack()):"error"==o.status&&p(o.content)},function(e){p(e.content)}):p("Invalid data provided!")}}},v=function(){var e={userId:r.localStorage.getItem("userId")||"",unique_id:r.localStorage.getItem("unique_id")||""};if(""===e.userId||""===e.unique_id)return u(i);var t=e.userId,o=r.localStorage.getItem("unique_id");return f(t,o).then(function(e){return"success"},function(e){return u(i)})};return v()};var g=function(e){r.localStorage.setItem("userId",e.data.content.userDetails.uid),r.localStorage.setItem("unique_id",e.data.content.userDetails.unique_id),d.data=e.data.content},f=function(e,t){var o=$.param({operation:"loginStatus",userId:e,unique_id:t});return l(o)},m=function(e){o.show();var t=$.param({operation:"loginUser",username:e.username,password:e.password});return l(t)}}]).factory("googleMapFactory",["$q","$window",function(e,t){var o=!1,n=e.defer();t.initMap=function(){o||(o=!0,n.resolve(document.getElementsByClassName("pac-container")))};var r=document.createElement("script");r.src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAZv-6hTAT3JfRWLaWiGvadnYvpsjR3DeU&libraries=places&callback=initMap",r.async=!0;var a=document.getElementsByTagName("script")[0];return a.parentNode.appendChild(r),{load:n.promise}}]).factory("imageUploader",["$cordovaFileTransfer","configs","userAuthServices","$ionicActionSheet","$ionicPopup","$cordovaFile","$cordovaCamera","$cordovaImagePicker","$q","$http","serverAddress",function(e,t,o,n,r,a,i,s,c,u,l){var d={numImageUploadable:0,maxImagesAllowed:0,setMaxImagesAllowed:function(e){this.maxImagesAllowed=e,this.numImageUploadable=e},maxImagesAllowedExceeded:function(){alert("Maximum "+this.maxImagesAllowed+" images can be attached!")},isMaxNoImagesExceeded:function(){return this.numImageUploadable<=0?(this.maxImagesAllowedExceeded(),!0):!1}},p=function(e){return a.createDir(cordova.file.dataDirectory,e.name,!0)},g=function(e,t){function o(e){var o=e.fullPath.substr(e.fullPath.lastIndexOf("/")+1),i=r(5)+o;window.resolveLocalFileSystemURL(cordova.file.dataDirectory+t.name,function(t){e.copyTo(t,i,n,a)},a)}function n(t){s.push(t.nativeURL),s.length===e.length&&i.resolve(s)}function r(e){for(var t="",o="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;e>n;n++)t+=o.charAt(Math.floor(Math.random()*o.length));return t}function a(e){i.reject("copying failed")}var i=c.defer(),s=Array();"string"==typeof e&&(e=Array(e));for(var u=0;u<e.length;u++)window.resolveLocalFileSystemURL(e[u],o,a);return i.promise},f=function(){var e={destinationType:Camera.DestinationType.FILE_URI,sourceType:Camera.PictureSourceType.CAMERA,correctOrientation:!0,encodingType:Camera.EncodingType.JPEG,targetHeight:800,targetWidth:800};return i.getPicture(e)},m=function(e){var t={maximumImagesCount:e,width:800,height:800,quality:80};return s.getPictures(t)},h=function(e){var t=c.defer(),o=[];return f().then(function(n){p(e).then(function(r){g(n,e).then(function(e){for(;e.length>0;)o.push(e.pop());i.cleanup(),t.resolve(o)})})},function(e){t.reject("capturing pics aborted")}),t.promise},v=function(e,t){var o=c.defer(),n=[];return m(t).then(function(t){p(e).then(function(r){g(t,e).then(function(e){for(;e.length>0;)n.push(e.pop());o.resolve(n)})})},function(e){o.reject("error getting pics")}),o.promise},y=function(o,n,r,a){function i(e){d.reject("error uploading file :"+e)}function s(e){n.splice(n.indexOf(e.filePath),1),r.push(e.newFileName),0===n.length&&d.resolve("upload completed")}function u(o,n,r){var a=t.country(),i={filePath:n,newFileName:""},s=c.defer(),u="insert",d=l+"/imageUploader.php",p={params:{directory:r,postId:o,operation:u,country:a}};return e.upload(d,n,p).then(function(e){var t=JSON.parse(e.response);return"success"==t.status?(i.newFileName=t.fileName,void s.resolve(i)):void s.reject(e.data)},function(e){s.reject(n)}),s.promise}var d=c.defer();if(0===n.length)return d.resolve("no image to upload"),d.promise;for(var p=n.length,g=0;p>g;g++)u(o,n[g],a).then(s,i);return d.promise},I=function(e,t){var o="delete",n=$.param({directory:"uploads",fileName:t,postId:e,operation:o});return u({url:l+"/imageUploader.php",method:"POST",data:n,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(e){return d.numImageUploadable++,e})},w=function(e,t){var o=(Array(),c.defer()),r={};if("post"==e?r.name="uploads":"profilePic"!=e&&"coverPic"!=e||(r.name="userProfilePics"),!d.isMaxNoImagesExceeded()||t){n.show({buttons:[{text:"Use Camera"},{text:"Select Images From Gallery"}],titleText:"Attach Images",cancelText:"Cancel",cancel:function(){o.reject("operation cancelled")},buttonClicked:function(e){return 0===e?h(r).then(function(e){o.resolve(e)}):1===e&&v(r).then(function(e){o.resolve(e)}),!0}});return o.promise}},P=function(e,t){t.splice(e,1),d.numImageUploadable++},S=function(t,n){function r(e,t){var o=e.substr(e.lastIndexOf("/")+1);return a.removeFile(cordova.file.dataDirectory+t,o).then(function(e){return e},function(e){return e})}var i=c.defer();d.numImageUploadable=1,d.setMaxImagesAllowed=1;var s=t.pop(),u="userProfilePics",p={filePath:s,newFileName:""},g="profilePic",f=l+"/imageUploader.php",m={params:{directory:u,userId:n,operation:g}};return e.upload(f,s,m,!0).then(function(e){var t=JSON.parse(e.response);return"success"==t.status?(p.newFileName=t.fileName,r(p.filePath,u),o.updateUserProfilePage(p.newFileName),void i.resolve(p)):void i.reject(e.data)},function(e){}),i.promise},C=function(){var e,t,o,a,i,s=function(){return e},d=function(){r.alert({title:"Error",template:"No more images can be uploaded. Max. "+t+" images allowed!",buttons:[{text:"ok"}]})},p=function(n,r,s,c){e=n,o=r,a=void 0==s?[]:s,i=c,t=n,void 0!=o&&(e-=o.length)},g=function(){var t={name:i};return v(t,e).then(function(t){for(e-=t.length;t.length>0;)a.push(t.pop())})},f=function(){var t={name:i};return h(t).then(function(t){a.push(t.pop()),e-=1})},m=function(){if(0>=e)return d(),!1;var o=c.defer();return n.show({buttons:[{text:"Use Camera"},{text:"Select Images From Gallery"}],titleText:"Attach Images (Max. "+t+" images allowed)",cancelText:"Cancel",cancel:function(){o.reject(null)},buttonClicked:function(e){return 0===e?f().then(function(){o.resolve(a)}):1===e&&g().then(function(){o.resolve(a)}),!0}}),o.promise},y=function(t){a.splice(a.indexOf(t),1),e++},I=function(t,n){var r="delete",a=$.param({directory:"uploads",fileName:n,postId:t,operation:r});return u({url:l+"/imageUploader.php",method:"POST",data:a,headers:{"Content-Type":"application/x-www-form-urlencoded;charset=utf-8;"}}).then(function(t){return o.splice(o.indexOf(n),1),e++,t})};return{init:p,showActionSheet:m,getMaxNumImage:s,removeImageFromView:y,removeFileFromServer:I}};return{init:d,imageUpldr:C,removeImageFromDevice:P,copyFilesToLocalDirectory:g,uploadImages:y,uploadProfilePic:S,showActionSheet:w,removeFileFromServer:I}}]).service("viewFullScreenModal",["$ionicModal","$ionicScrollDelegate",function(e,t){this.init=function(o,n){return o.slideHasChanged=function(e){t.$getByHandle("scrollHandle"+e).zoomTo(1),o.active=e},o.closeModal=function(){o.viewFullScreenModal.hide()},o.$on("$destory",function(){o.viewFullScreenModal.remove()}),e.fromTemplateUrl("templates/modal-image.html",{scope:o})}}]);